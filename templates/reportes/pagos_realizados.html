{% extends "base.html" %}

{% block title %}Pagos Realizados{% endblock %}

{% block content %}
<div class="container">
    <h2 class="text-center mb-4">Pagos Realizados</h2>

    <!-- Filtros -->
    <form method="GET" class="mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="grupo_id" class="form-label">Grupo</label>
                <select class="form-select" name="grupo_id" id="grupo_id">
                    <option value="">Selecciona un grupo</option>
                    {% for grupo in grupos %}
                    <option value="{{ grupo.id }}" {% if request.args.get('grupo_id') == grupo.id|string %}selected{% endif %}>
                        {{ grupo.nombre }}
                    </option>
                    {% endfor %}
                </select>
                
            </div>
            <div class="col-md-4">
                <label for="prestamo_grupal_id" class="form-label">Préstamo Grupal</label>
                <select class="form-select" name="prestamo_grupal_id" id="prestamo_grupal_id" {% if not request.args.get('grupo_id') %}disabled{% endif %}>
                    <option value="">Selecciona un préstamo grupal</option>
                    {% for prestamo in prestamos_grupales %}
                    <option value="{{ prestamo.id }}" {% if request.args.get('prestamo_grupal_id') == prestamo.id|string %}selected{% endif %}>
                        Préstamo #{{ prestamo.id }}
                    </option>
                    {% endfor %}
                </select>
                
            </div>
            <div class="col-md-4">
                <label for="cliente_id" class="form-label">Cliente</label>
                <select class="form-select" name="cliente_id" id="cliente_id" {% if not request.args.get('grupo_id') %}disabled{% endif %}>
                    <option value="">Selecciona un cliente</option>
                    {% for cliente in clientes %}
                    <option value="{{ cliente.id }}" {% if request.args.get('cliente_id') == cliente.id|string %}selected{% endif %}>
                        {{ cliente.nombre }} {{ cliente.apellido }}
                    </option>
                    {% endfor %}
                </select>
                
            </div>
        </div>
        <div class="text-center mt-3">
            <button type="submit" class="btn btn-primary">Filtrar</button>
        </div>
    </form>

    <!-- Mostrar tabla solo si hay resultados -->
    {% if pagos %}
    <table class="table table-dark table-striped mt-4">
        <thead>
            <tr>
                <th>#</th>
                <th>Cliente</th>
                <th>Grupo</th>
                <th>Préstamo Grupal</th>
                <th>Monto Pagado</th>
                <th>Fecha de Pago</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for pago in pagos %}
            <tr>
                <td>{{ pago.id }}</td>
                <td>{{ pago.cliente.nombre }} {{ pago.cliente.apellido }}</td>
                <td>{{ pago.cliente.grupo.nombre if pago.cliente.grupo else 'N/A' }}</td>
                <td>{{ pago.prestamo_individual.prestamo_grupal.id if pago.prestamo_individual.prestamo_grupal else 'N/A' }}</td>
                <td>S/. {{ pago.monto_pagado }}</td>
                <td>{{ pago.fecha_pago.strftime('%d-%m-%Y') }}</td>
                <td>{{ pago.estado }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-center text-warning mt-4">No hay pagos realizados. Usa los filtros para buscar registros.</p>
    {% endif %}
</div>

<!-- Script para actualizar filtros dinámicamente -->
<script>
document.getElementById("grupo_id").addEventListener("change", function() {
    let grupoId = this.value;
    let prestamoSelect = document.getElementById("prestamo_grupal_id");
    let clienteSelect = document.getElementById("cliente_id");

    if (grupoId) {
        fetch(`/reportes/get_prestamos_clientes?grupo_id=${grupoId}`)
            .then(response => response.json())
            .then(data => {
                console.log("Datos recibidos:", data);  // Verifica qué datos llegan

                prestamoSelect.innerHTML = '<option value="">Selecciona un préstamo grupal</option>';
                clienteSelect.innerHTML = '<option value="">Selecciona un cliente</option>';

                if (data.prestamos.length > 0) {
                    data.prestamos.forEach(prestamo => {
                        let option = document.createElement("option");
                        option.value = prestamo.id;
                        option.textContent = `Préstamo #${prestamo.id}`;
                        prestamoSelect.appendChild(option);
                    });
                    prestamoSelect.disabled = false;
                } else {
                    prestamoSelect.innerHTML = '<option value="">No hay préstamos para este grupo</option>';
                    prestamoSelect.disabled = true;
                }

                if (data.clientes.length > 0) {
                    data.clientes.forEach(cliente => {
                        let option = document.createElement("option");
                        option.value = cliente.id;
                        option.textContent = `${cliente.nombre} ${cliente.apellido}`;
                        clienteSelect.appendChild(option);
                    });
                    clienteSelect.disabled = false;
                } else {
                    clienteSelect.innerHTML = '<option value="">No hay clientes en este grupo</option>';
                    clienteSelect.disabled = true;
                }
            })
            .catch(error => console.error("Error al cargar los datos:", error));  // Si hay errores, los veremos aquí
    } else {
        prestamoSelect.innerHTML = '<option value="">Selecciona un grupo primero</option>';
        clienteSelect.innerHTML = '<option value="">Selecciona un grupo primero</option>';
        prestamoSelect.disabled = true;
        clienteSelect.disabled = true;
    }
});


</script>

{% endblock %}
