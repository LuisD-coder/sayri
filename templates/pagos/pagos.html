{% extends "base.html" %}

{% block title %}Gestión de Pagos{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="text-center mb-4 text-white bg-dark p-3 rounded">Gestión de Pagos</h2>

    <div class="card shadow-lg border-0 mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('pagos.lista_pagos') }}">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <label for="grupo_id" class="form-label fw-semibold">Seleccionar Grupo:</label>
                        <select name="grupo_id" id="grupo_id" class="form-select border-primary" required>
                            <option value="">Selecciona un grupo</option>
                            {% for grupo in grupos %}
                                <option value="{{ grupo.id }}" {% if grupo.id == selected_grupo.id %}selected{% endif %}>{{ grupo.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100 shadow">Ver Préstamos</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if selected_grupo %}
        <h3 class="text-center mb-4 text-white bg-primary p-3 rounded">Pagos del Grupo: <span class="fw-bold">{{ selected_grupo.nombre }}</span></h3>

        <form id="pagos-form" method="POST" action="{{ url_for('pagos.guardar_pagos', grupo_id=selected_grupo.id) }}">
            {% for prestamo_grupal in prestamos_grupales %}
                <div class="card mb-4 shadow-lg border-0">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Préstamo Grupal: S/. {{ prestamo_grupal.monto_total }}</h5>
                        <small>Desembolso: {{ prestamo_grupal.fecha_desembolso.strftime('%d/%m/%Y') }}</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="row bg-light py-2 px-3 fw-bold border-bottom d-none d-md-flex">
                            <div class="col-md-3">Cliente</div>
                            <div class="col-md-2 text-center">Fecha de Pago</div>
                            <div class="col-md-2 text-center">Cuota</div>
                            <div class="col-md-3 text-center">Nuevo Abono</div>
                            <div class="col-md-2 text-center">Pago Completo</div>
                        </div>

                        {% for prestamo in prestamo_grupal.prestamos_individuales %}
                            {% set pagos_ordenados = prestamo.pagos|sort(attribute='fecha_pago') %}
                            {% set pago_activo = prestamo.pagos|selectattr('estado', 'in', ['Pendiente', 'Atrasado', 'Incompleto'])|sort(attribute='fecha_pago')|first %}
                            {% set numero_cuota = loop.index if not pago_activo else (pagos_ordenados.index(pago_activo) + 1) %}

                            {% set row_class = "" %}
                            {% if pago_activo and pago_activo.estado == 'Incompleto' %}
                                {% set row_class = "pago-incompleto" %}
                            {% elif pago_activo and pago_activo.estado == 'Atrasado' %}
                                {% set row_class = "pago-atrasado" %}
                            {% endif %}

                            <div class="row align-items-center py-2 px-3 mb-3 border-bottom-dashed {{ row_class }}">
                                <div class="col-md-3 col-12 mb-2 mb-md-0">
                                    <strong class="d-md-none">Cliente: </strong>{{ prestamo.cliente.nombre }} {{ prestamo.cliente.apellido }}
                                    <input type="hidden" name="prestamo_individual_id_{{ prestamo.id }}" value="{{ prestamo.id }}">
                                </div>
                                <div class="col-md-2 col-6 mb-2 mb-md-0 text-md-center">
                                    <strong class="d-md-none">Fecha de Pago: </strong>
                                    {% if pago_activo %}
                                        <span class="fw-bold text-info">{{ pago_activo.fecha_pago.strftime('%d/%m/%Y') }}</span>
                                        <br>
                                        <span class="badge bg-secondary">Cuota #{{ numero_cuota }}</span>
                                    {% else %}
                                        <span class="text-secondary">No hay cuotas pendientes</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-2 col-6 mb-2 mb-md-0 text-md-center">
                                    <strong class="d-md-none">Cuota: </strong>
                                    <span class="monto-cuota-display fw-bold">S/. {{ '%.2f' % prestamo.obtener_numero_cuota() }}</span>
                                </div>
                                <div class="col-md-3 col-6 mb-2 mb-md-0">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <strong class="d-md-none">Abono: </strong>
                                            <input type="number" name="monto_abonado_{{ prestamo.id }}"
                                                   class="form-control form-control-sm monto-abonado text-center"
                                                   step="0.01"
                                                   placeholder="0.00"
                                                   value=""
                                                   data-cuota="{{ prestamo.obtener_numero_cuota() }}"
                                                   data-prestamo-id="{{ prestamo.id }}"
                                                   {% if not pago_activo %}disabled{% endif %}>
                                        </div>
                                        <div class="col-md-4">
                                            {% if pago_activo and pago_activo.estado == 'Incompleto' %}
                                                <div class="text-center">
                                                    <small class="text-muted d-block">Ya pagó:</small>
                                                    <span class="badge bg-info text-dark">S/ {{ '%.2f' % pago_activo.monto_pagado }}</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2 col-6 mb-2 mb-md-0 text-md-center">
                                    <div class="form-check form-check-inline d-flex justify-content-center">
                                        <input class="form-check-input pago-completo" type="checkbox"
                                               name="pago_completo_{{ prestamo.id }}" 
                                               id="pago_completo_{{ prestamo.id }}" 
                                               value="true"
                                               data-prestamo-id="{{ prestamo.id }}"
                                               {% if not pago_activo or pago_activo.estado == 'Pagado' %}checked disabled{% endif %}>
                                        <label class="form-check-label d-md-none" for="pago_completo_{{ prestamo.id }}">Completado</label>
                                    </div>
                                    {% if pago_activo and pago_activo.estado == 'Pagado' %}
                                        <span class="badge bg-success ms-2 d-none d-md-inline">✅ Pagado</span>
                                    {% elif pago_activo and pago_activo.estado == 'Incompleto' %}
                                        <span class="badge bg-warning text-dark ms-2 d-none d-md-inline">⚠️ Pendiente: S/ {{ '%.2f' % pago_activo.monto_pendiente }}</span>
                                    {% elif pago_activo and pago_activo.estado == 'Atrasado' %}
                                        <span class="badge bg-danger ms-2 d-none d-md-inline">⚠️ Atrasado</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}

            <div class="row mt-4">
                <div class="col-md-6 offset-md-6">
                    <div class="card shadow-sm border-0 bg-light p-3">
                        <h5 class="mb-2 text-dark">Total Cuota Grupo: S/. <span id="total_cuota_grupo" class="fw-bold">0.00</span></h5>
                        <h5 class="mb-0 text-primary">Suma de Abonos: S/. <span id="suma_total_abonos" class="fw-bold">0.00</span></h5>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5">
                <button type="submit" class="btn btn-success btn-lg shadow">Guardar Pagos del Grupo</button>
            </div>
        </form>
    {% endif %}
</div>

<style>
    .pago-incompleto {
        background-color: #fff3cd !important; /* Color de fondo amarillo claro */
        border: 2px solid #ffc107; /* Borde amarillo más visible */
        border-radius: 0.5rem;
    }
    .pago-atrasado {
        background-color: #f8d7da !important; /* Color de fondo rojo claro */
        border: 2px solid #dc3545; /* Borde rojo más visible */
        border-radius: 0.5rem;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const pagosForm = document.getElementById('pagos-form');
        const montoAbonadoInputs = pagosForm.querySelectorAll('.monto-abonado:not([disabled])');
        const pagoCompletoCheckboxes = pagosForm.querySelectorAll('.pago-completo:not([disabled])');
        const totalCuotaGrupoSpan = document.getElementById('total_cuota_grupo');
        const sumaTotalAbonosSpan = document.getElementById('suma_total_abonos');

        function calcularTotales() {
            let totalCuotaGrupo = 0;
            let sumaTotalAbonos = 0;

            pagosForm.querySelectorAll('.monto-abonado').forEach(input => {
                const montoCuota = parseFloat(input.getAttribute('data-cuota')) || 0;
                totalCuotaGrupo += montoCuota;

                const montoAbonado = parseFloat(input.value) || 0;
                sumaTotalAbonos += montoAbonado;
            });

            totalCuotaGrupoSpan.textContent = totalCuotaGrupo.toFixed(2);
            sumaTotalAbonosSpan.textContent = sumaTotalAbonos.toFixed(2);
        }

        montoAbonadoInputs.forEach(input => {
            input.addEventListener('input', calcularTotales);
        });

        pagoCompletoCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const prestamoId = this.getAttribute('data-prestamo-id');
                const montoInput = document.querySelector(`input[name="monto_abonado_${prestamoId}"]`);
                const montoCuota = parseFloat(montoInput.getAttribute('data-cuota'));
                
                // Obtener el monto ya pagado si existe (del badge)
                const badgePagado = document.querySelector(`input[name="monto_abonado_${prestamoId}"]`)
                    .closest('.col-md-3')
                    .querySelector('.badge.bg-info');
                
                let montoYaPagado = 0;
                if (badgePagado) {
                    // Extraer el número del texto del badge "S/ XX.XX"
                    const textoBadge = badgePagado.textContent.trim();
                    const match = textoBadge.match(/S\/\s*([\d,]+\.?\d*)/);
                    if (match) {
                        montoYaPagado = parseFloat(match[1].replace(',', ''));
                    }
                }
                
                if (this.checked) {
                    // Calcular el monto faltante
                    const montoFaltante = montoCuota - montoYaPagado;
                    montoInput.value = Math.max(0, montoFaltante).toFixed(2);
                } else {
                    // Si desmarca el checkbox, limpiar el input solo si contiene el valor calculado
                    const valorActual = parseFloat(montoInput.value) || 0;
                    const montoFaltante = montoCuota - montoYaPagado;
                    
                    if (Math.abs(valorActual - montoFaltante) < 0.01 || Math.abs(valorActual - montoCuota) < 0.01) {
                        montoInput.value = '';
                    }
                }
                calcularTotales();
            });
        });

        pagosForm.querySelectorAll('.pago-completo').forEach(checkbox => {
            const prestamoId = checkbox.getAttribute('data-prestamo-id');
            const montoInput = document.querySelector(`input[name="monto_abonado_${prestamoId}"]`);
            if (checkbox.checked && !checkbox.disabled) {
                 const montoCuota = parseFloat(montoInput.getAttribute('data-cuota'));
                 montoInput.value = montoCuota.toFixed(2);
            }
        });

        calcularTotales();
    });
</script>
{% endblock %}